# 需求文档

## 介绍

期货席位分析系统是一个基于本地数据库的综合数据分析平台，专为单用户使用设计。系统基于React/TypeScript技术栈，使用SQLite3数据库，处理来自6家期货交易所约120个期货品种的行情数据和席位持仓数据。通过主页面+副页面的双页面设计，提供专业的席位分析工具、多维度指标组、分析图表和多条件组合筛选功能。

## 需求

### 需求 1

**用户故事：** 作为期货分析师，我希望能够查看实时K线图和持仓数据表，以便同时分析市场趋势和席位持仓情况。

#### 验收标准

1. 当系统加载时，系统应显示主页面，左列75%包含K线区（40%高度）和指标区（60%高度），右列25%包含持仓数据表、席位数据表、按钮区和自选列表
2. 当我点击自选列表中的品种时，系统应相应更新K线图、指标区、持仓数据表和席位数据表
3. 当我在K线区滚动鼠标滚轮时，系统应按顺序显示自选列表中品种的K线图
4. 当我右键点击K线图时，系统应显示"加入自选"选项，将该品种添加到自选列表
5. 当显示K线图时，系统应使用红色空心阳线和绿色空心阴线，并在左侧显示透明数据窗口包含品种简称、涨幅、收盘价、昨结、成交量、持仓量

### 需求 2

**用户故事：** 作为期货分析师，我希望通过多个指标组分析持仓数据，以便了解市场持仓分布和变化情况。

#### 验收标准

1. 当我点击"实多空"按钮时，指标区应切换到模版1，分三行显示实多空指标组（实多10/20/X，实空10/20/X，实差10/20/X）的250个交易日数据
2. 当我点击"净多空"按钮时，指标区应切换到模版1，分三行显示净多空指标组（净多10/20/X，净空10/20/X，净差10/20/X）的250个交易日数据
3. 当我点击"流多空"按钮时，指标区应切换到模版1，分三行以柱状图显示流多空指标组（加多/加空/减多/减空 10/20/X）的250个交易日数据
4. 当我点击"净持六"按钮时，指标区应切换到模版2，显示净持仓量前6席位250个交易日的净持仓曲线
5. 当我反复点击"趋势六"按钮时，系统应循环显示趋势05、趋势15、趋势30前6席位的250个交易日净持仓曲线
6. 当我反复点击"盈亏六"按钮时，系统应循环显示盈亏15、盈亏60、盈亏120前6席位的250个交易日净持仓曲线

### 需求 3

**用户故事：** 作为期货分析师，我希望以表格形式查看详细的持仓和席位数据，以便分析具体的数值数据和排名情况。

#### 验收标准

1. 当系统显示持仓数据表时，应显示8列：席位名称、多头持仓（黄字）、多头增减（红字，带+/-号）、空头持仓（黄字）、空头增减（绿字，带+/-号）、净持仓量（黄字，带+/-号）、净持增减（正值红色带+号，负值绿色带-号）、持仓占比（正值红色，负值绿色）
2. 当我点击表头时，系统应支持所有列的双向排序，净持仓量按绝对值降序排序
3. 当系统显示席位数据表时，应显示8列：席位名称、盈亏15、盈亏60、盈亏120、空列、趋势05、趋势15、趋势30
4. 当我点击表格中的席位名称时，系统应在指标区添加相应的曲线
5. 当表格数据超过显示区域时，系统应支持滚动查看所有席位数据，页面显示8行8列

### 需求 4

**用户故事：** 作为期货分析师，我希望通过饼图可视化持仓分布，以便了解不同席位持仓的比例和变化情况。

#### 验收标准

1. 当我点击"饼图二"按钮时，指标区应切换到模版2，左侧显示持仓变化环图，右侧显示持仓分布环图
2. 当我悬停在外环扇形区域时，系统应高亮显示该区域并显示浮动透明窗口包含席位名称、持仓量/增减量、持仓比/增减比
3. 当我悬停在内环扇形区域时，系统应显示浮动透明窗口包含多空总量和比例信息
4. 当持仓比或增减比小于1%时，系统应将小席位合并为"其他"类别
5. 当显示环图时，外环应按净持仓量从大到小顺时针/逆时针排布，内环右侧显示净多（红色），左侧显示净空（绿色）

### 需求 5

**用户故事：** 作为期货分析师，我希望基于多个条件筛选品种，以便识别符合特定标准的品种。

#### 验收标准

1. 当我点击"副页面"按钮时，应显示副页面（25%宽度，75%高度），上2/3为筛选条件表，下1/3为筛选结果表
2. 当我设置筛选条件时，系统应支持9种条件组合：收盘价条件（5/8/13/21日内最高/最低）、实多空比较、净多空比较、实多空极值、实差极值、净多空极值、净差极值
3. 当我点击"执行筛选"按钮时，系统应基于选定条件筛选所有加权合约
4. 当我点击"导出结果"按钮时，系统应将筛选结果导出到结果表（6行6列显示，滚动支持12行）
5. 当我点击结果表中的品种名称时，系统应更新主页面的K线区、指标区和数据表

### 需求 6

**用户故事：** 作为系统用户，我希望有自动数据更新和手动备份选项，以便确保数据新鲜度并处理更新失败。

#### 验收标准

1. 当交易日下午4:30、5:00、5:30和6:00时，系统应自动调用外部API更新数据四次
2. 当外部API请求失败或数据异常时，系统应显示错误提醒通知
3. 当我点击手动更新按钮时，系统应执行数据更新以处理自动更新失败
4. 当数据更新后，系统应显示时间戳以避免重复更新
5. 当系统需要数据时，所有必需数据应在SQLite数据库中缓存以提高访问速度

### 需求 7

**用户故事：** 作为系统用户，我希望有加权合约计算和席位分析汇总功能，以便分析超越单个合约的品种级数据。

#### 验收标准

1. 当新的行情数据到达时，系统应通过使用持仓权重合并同品种合约来计算加权合约，公式：总持仓量=Σ各月份合约持仓量，持仓权重=合约持仓量/总持仓量，加权价格=Σ(合约价格×合约权重)
2. 当计算加权价格时，系统应排除持仓量为0的合约，保留两位小数，每日收到新数据后计算一次
3. 当处理持仓数据时，系统应按品种汇总席位持仓并计算净持仓量（long_vol-short_vol）和净持增减（long_chg-short_chg）
4. 当新品种上市时，系统应自动处理并将其包含在计算中
5. 当计算盈亏数据时，系统应使用公式：单日盈亏=(今日净持仓量×今结算价-昨日净持仓量×昨结算价)×合约单位，盈亏15/60/120为对应交易日单日盈亏累和

### 需求 8

**用户故事：** 作为期货分析师，我希望有简拼输入和品种选择功能，以便快速切换分析的品种。

#### 验收标准

1. 当我在简拼输入框输入拼音首字母时，系统应自动弹出下拉框显示匹配的品种简称
2. 当我在下拉框中选择某品种时，该品种的简称应显示在品种显示框中
3. 当我点击品种显示框内的品种简称时，系统应刷新K线区、指标区、持仓数据表、席位数据表
4. 当我右键点击品种显示框时，系统应显示"加入自选"选项
5. 当我在自选列表中右键点击品种按钮时，系统应显示"删除自选"选项，支持拖拽排序

### 需求 9

**用户故事：** 作为期货分析师，我希望有详细的指标计算和显示功能，以便深入分析席位持仓变化。

#### 验收标准

1. 当计算实多空指标时，系统应将所有席位的持买单量和持卖单量合并排序，选前10/20/全部席位，计算净持仓量大于0的累计和（实多）和小于0的绝对值累计和（实空）
2. 当计算净多空指标时，系统应将所有席位的净持仓量取绝对值排序，选前10/20/全部席位，分别计算正值累计和（净多）和负值绝对值累计和（净空）
3. 当计算流多空指标时，系统应根据净持仓量和净持增减的正负组合，计算加多（净持>0且净增>0）、加空（净持<0且净增<0）、减多（净持>0且净增<0）、减空（净持<0且净增>0）
4. 当计算趋势指标时，系统应使用公式：趋势N=max(abs(今日净持仓量-N日内最小值), abs(今日净持仓量-N日内最大值))，N为5/15/30
5. 当显示指标时，实多/净多/加多/减空用红色，实空/净空/加空/减多用绿色，实差/净差用黄色虚线独立坐标